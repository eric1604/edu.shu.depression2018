<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" name="viewport" content="width=device-width, initial-scale=1, charset=utf-8">
    <title>選擇諮商師</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <link href="./css/two.css" rel="stylesheet" type="text/css">
    <link href="./css/all.css" rel="stylesheet" type="text/css">
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>

    <style type="text/css">
		.msg{
			background-color: aqua !important;
			padding: 5px;
		}
		.ui-content td:first-child{padding-right: 10px;}
		.name{font-size: 25px;}
		.time{
			color: lightgray;
			font-size: 12px;
		}
    </style>
    
    <script type="text/javascript">
		$(document).ready(function(){$("#btnhome").click(function(){
			if(window.localStorage["Mode"] == "諮商師"){location.href = "consultant/MAIN.html";}
			else{location.href = "main.html";}
		})});
		$(document).ready(getmsg);
		
		function backbtn(){
			document.addEventListener("deviceready",function(){
				document.addEventListener("backbutton",function(){
					if(window.localStorage["Mode"] == "諮商師"){location.href = "consultant/MAIN.html";}
			        else{location.href = "main.html";}
			    },false);
			},false);
		}
		
		function getmsg(){
			var userdata = {ID: window.localStorage["ID"],chk: false};
			var data = JSON.stringify(userdata);
			
			$.ajax({
				url: "http://192.192.155.108/serv/ServicePool.asmx/GetMessage",
                dataType: "text",
				contentType: "application/json; charset=utf-8",
				data: data,
                type: "POST",
                async: false,
                success: function(check){
					var msg = (JSON.parse(check)).d;
					var title;
					
					if(msg[0][0] == "目前沒有任何通知 !")
					{
						document.addEventListener("deviceready",function(){
							navigator.notification.alert(
								msg[0][0],
								function(){location.href="consultant/MAIN.html";},
								'與你相鬱好幸運',
								'確定'
							);
						},false);
					}else
					{
						for(i=0;i<msg.length;i++)
					    {
					    	switch(msg[i][1]){
					        	case "new":
					        		title = "您有一位新的諮商對象 !"
					        		break;
								case "chg":
									title = "一位諮商對象已更換諮商師。"
					        }
					    	if(msg[i][3] != ""){imgsrc = msg[i][3];}
					    	else{imgsrc = "img/member.webp";}
							
					    	var newmsg = "<div data-role='collapsible' data-collapsed-icon='carat-d' data-expanded-icon='carat-u' data-inset='false'><h4>" + title + "</h4><table align='center' width='100%'><tr><td width='50px'><img src='" + imgsrc + "' width='100%'></td><td width='50%'><span class='name'>" + msg[i][2] + "</span><br/><span class='time'>" + msg[i][4] + "</span></td><td><input class='clean' onClick='delmsg(" + msg[i][0] + ")' type='button' data-mini='true' value='清除'></td></tr><tr><td colspan='3'><div class='msg'>" + msg[i][5] + "</div></td></tr></table></div>";
							
							if(msg[i][5] == "")
							{
								newmsg = "<div data-role='collapsible' data-collapsed-icon='carat-d' data-expanded-icon='carat-u' data-inset='false'><h4>" + title + "</h4><table align='center' width='100%'><tr><td width='50px'><img src='" + imgsrc + "' width='100%'></td><td width='50%'><span class='name'>" + msg[i][2] + "</span><br/><span class='time'>" + msg[i][4] + "</span></td><td><input class='clean' onClick='delmsg(" + msg[i][0] + ")' type='button' data-mini='true' value='清除'></td></tr></table></div>";
							}
					    	
					    	$(".ui-content").append($(newmsg).collapsible());
					    	$(".clean").button().button("refresh");
					    }
					}
					document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
				},
                error: function(xhr, ajaxOptions, thrownError) {
					document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
					if(thrownError.toString().slice(0,12) == "NetworkError")
					{
						document.addEventListener("deviceready",function(){
							history.back();
			                navigator.notification.alert(
                                '伺服器連線失敗，請檢查網路。',
                                null,
                                '⚠️ 錯誤',
                                '確定'
                            );
			            },false);
					}else
					{
						alert("[Ready State] " + xhr.readyState + "\n[Ajax Options] " + ajaxOptions + "\n[Thrown Error]\n" + thrownError + "\n\n[Response Text] " + xhr.responseText);
					}
                }
			});
		}
		
		function delmsg(dbid){
			document.addEventListener("deviceready",function(){
				navigator.notification.confirm(
					'確定要清除這則通知嗎 ?',
					function(btnIndex){if(btnIndex == 1){del();}},
					'與你相鬱好幸運',
					["確定","取消"]
				);
			},false);
			
			function del(){
				var userData = {dbid: dbid};
				var data = JSON.stringify(userData);
				
				$.ajax({
					url: "http://192.192.155.108/serv/ServicePool.asmx/DeleteMessage",
                    dataType: "text",
				    contentType: "application/json; charset=utf-8",
				    data: data,
                    type: "POST",
                    async: false,
                    success: function(){location.reload();},
                    error: function(xhr, ajaxOptions, thrownError) {
				    	if(thrownError.toString().slice(0,12) == "NetworkError")
				    	{
				    		document.addEventListener("deviceready",function(){
				    			history.back();
			                    navigator.notification.alert(
                                    '伺服器連線失敗，請檢查網路。',
                                    null,
                                    '⚠️ 錯誤',
                                    '確定'
                                );
			                },false);
				    	}else
				    	{
				    		alert("[Ready State] " + xhr.readyState + "\n[Ajax Options] " + ajaxOptions + "\n[Thrown Error]\n" + thrownError + "\n\n[Response Text] " + xhr.responseText);
				    	}
                    }
				});
			}
		}
	</script>

</head>
<body onLoad="backbtn()">
    <div data-role="page" id="pageone">
        <div style="font-size:22px" data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="a">
            <h1 onClick="getmsg()"><img style="padding-top: 4px" src="img/informationtitlesection.webp" width="100%"></h1>
			<a id="btnhome" class="ui-btn-right" style="top:12px" data-role="button" ><img src="img/home.webp" border="0"></a>
        </div>
		<div data-role="content"></div>
    </div>
	
</body>
</html>

