<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" name="viewport" content="width=device-width, initial-scale=1; charset=utf-8">
    <title>更改資料</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <link href="./css/two.css" rel="stylesheet" type="text/css">
    <link href="./css/all.css" rel="stylesheet" type="text/css">
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <link href="./node_modules/cropper/dist/cropper.css" rel="stylesheet">
    <script src="./node_modules/cropper/dist/cropper.js"></script>
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>

    <style type="text/css">
	  #info{
		  background-color: aquamarine;
		  font-size: 15px;
	  }
	  table{padding-top: 0px;}
	  #prvlbl{visibility: hidden;}
	  #preview{display: none;}
    </style>
    
    <script type="text/javascript">
		$(document).ready(function(){$("#btnprev").click(function(){location.href="D_member.html";})});
		$(document).ready(function(){$("#btnhome").click(function(){
		    if(window.localStorage["Mode"] == "諮商師"){location.href="./consultant/MAIN.html";}
		       else{location.href="main.html";}
	    })});
		$(document).ready(function(){$(".label").css({fontWeight:"bold"})});
		$(document).ready(function(){$("#btnchange").click(update)});
		$(document).ready(function(){$("#btnchoose").click(function(){document.getElementById("inputimg").click();})});
		$(document).ready(function(){
			if(window.localStorage["Mode"] == "諮商師"){$("#petlbl").css("display","none");}
		});
		
		var image;
		var imagebase64 = "";
		var noimg = 0;
		var delimg = document.querySelector("input[id=delimg]");

		function backbtn(){
			document.addEventListener("deviceready",function(){
				document.addEventListener("backbutton",function(){
					location.href="D_member.html";
				},false);
			},false);
			$("#inputimg").hide();
		}
		
		function getimage()
		{
			noimg = 2;
			document.addEventListener("deviceready",function(){SpinnerPlugin.activityStart("圖片載入中...");},false);
			$(".imglbl").css("display","none");
			document.querySelector("label").style.display = "none";
            var preview = document.getElementById("preview");
            var file    = document.querySelector('input[type=file]').files[0];
            var reader  = new FileReader();

            reader.addEventListener("load", function(){
			  document.getElementById("preview").style.display = "block";
              preview.src = reader.result;
			  $("#preview").cropper({
				  viewMode: 1,
				  aspectRatio: 1/1,
				  zoomable: false,
				  rotatable: false,
				  crop: function(){document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);}
			  })
            }, false);
			
            if (file){reader.readAsDataURL(file);}
        }
		
		function update()
        {
			if(noimg == 2)
			{
				noimg = 0;
				image = $("#preview").cropper("getCroppedCanvas");
			    imagebase64 = image.toDataURL('image/webp');
			}
			document.addEventListener("deviceready",function(){SpinnerPlugin.activityStart("載入中...");},false);
			if($("#delimg").prop("checked") && imagebase64 == ""){imagebase64 = "";noimg = 1;}
			var newName = {ID: window.localStorage["ID"],NAME: $("#NEWNAME").val(),PWD: $("#PWD").val(),PETNAME: $("#petname").val(),IMAGE: imagebase64,noimg: noimg};
			var data = JSON.stringify(newName);
			 
			$.ajax({
                url: "http://192.192.155.108/serv/ServicePool.asmx/UpdateData",
                contentType: "application/json; charset=utf-8",
                dataType: "text",
				data: data,
                type: "POST",
                async: false,
                success: function(check){
					if($("#NEWNAME").val() != ""){window.localStorage["Name"] = $("#NEWNAME").val();}
					if($("#petname").val() != ""){window.localStorage["Petname"] = $("#petname").val();}
					if(imagebase64 != ""){window.localStorage["Image"] = imagebase64;}
					else if(noimg == 1)
					{
						if(window.localStorage["Mode"] == "諮商師"){window.localStorage["Image"] = "../img/member.webp";}
						else{window.localStorage["Image"] = "img/member.webp";}
					}
					var name = (JSON.parse(check)).d;
					document.addEventListener("deviceready",function(){
						    SpinnerPlugin.activityStop();
							navigator.notification.alert(
                                name,
                                function(){location.reload();},
                                '更改完成',
                                '確定'
                            );
			            },false);
					if(name == "沒有資料需要更改。"){
						document.addEventListener("deviceready",function(){
							SpinnerPlugin.activityStop();
							navigator.notification.alert(
                                name,
                                null,
                                '一切安好',
                                '確定'
                            );
			            },false);
					}
				},
                error: function(xhr, ajaxOptions, thrownError) {
					document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
					if(thrownError.toString().slice(0,12) == "NetworkError")
					{
						document.addEventListener("deviceready",function(){
			                navigator.notification.alert(
                                '伺服器連線失敗，請檢查網路。',
                                null,
                                '⚠️ 錯誤',
                                '確定'
                            );
			            },false);
					}else
					{
						alert("[Ready State] " + xhr.readyState + "\n[Ajax Options] " + ajaxOptions + "\n[Thrown Error]\n" + thrownError + "\n\n[Response Text] " + xhr.responseText);
					}
                }
            });
        }
	</script>

</head>
<body onLoad="backbtn()">
    <div data-role="page" id="pageone">
        <div style="font-size:10px;text-align: center" data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="a">
            <h1><img style="padding-top: 12px" src="img/memberchangtitlle.webp" width="100%"></h1>
			<a id="btnprev" style="top:12px" data-role="button" ><img src="img/up.webp" border="0"></a>
            <a id="btnhome" style="top:10px" data-role="button" ><img src="img/home.webp" border="0"></a>
			<span id="info">&nbsp;不需更改的項目請留白&nbsp;</span>
        </div>
        
        <div align="center" data-role="content">
			<br/>
            <table width="90%" align="center" border="0">
            	<tbody align="center" valign="middle" style="height: auto">
            		<tr>
            			<td width="20%" class="label">暱稱&nbsp;</td>
            			<td colspan="2"><input type="text" id="NEWNAME"/></td>
            		</tr>
            		<tr>
                       <td class="label">密碼&nbsp;</td>
                       <td colspan="2"><input type="password" id="PWD"/></td>
                    </tr>
		    		<tr id="petlbl">
                       <td class="label">夥伴&nbsp;<br/>名字&nbsp;</td>
                       <td colspan="2"><input type="text" id="petname"/></td>
                    </tr>
                    <tr>
                       <td class="label">照片&nbsp;</td>
                       <td class="imglbl" align="left" width="60%"><input type="button" id="btnchoose" value="選擇照片"></td>
		    		   <td class="imglbl" width="20%"><input type="checkbox" id="delimg"><label style="width: 16px" for="delimg">刪</label></td>
		    		   <td colspan="2"><img id="preview" src="" width="100%" alt="(圖片預覽)"></td>
                    </tr>
		    		<tr>
            			<td colspan="3"><input type="file" id="inputimg" onchange="getimage()" accept="image/*"/></td>
            		</tr>
            		<tr>
            			<td colspan="3"><input id="btnchange" type="button" value="更改" /></td>
            		</tr>
            	</tbody>
            </table>
		</div>
    </div>
</body>
</html>

