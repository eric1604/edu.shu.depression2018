<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" name="viewport" content="width=device-width, initial-scale=1; charset=utf-8">
    <title>註冊新帳號</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <link href="./css/two.css" rel="stylesheet" type="text/css">
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <link href="./node_modules/cropper/dist/cropper.css" rel="stylesheet">
    <script src="./node_modules/cropper/dist/cropper.js"></script>
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    
    <style>
		#preview{display: none;}
	</style>

    <script type="text/javascript">
		$(document).ready(function(){$("#btnnext").click(register)});
		$(document).ready(function(){$("#btnprev").click(function(){location.href = "login.html";})});
		$(document).ready(function(){$(".label").css({fontWeight:"bold"})});
		$(document).ready(function(){$("#btnchoose").click(function(){document.getElementById("inputimg").click();})});
		
		var imagebase64 = "";
		
		function backbtn(){
			document.addEventListener("deviceready",function(){
				document.addEventListener("backbutton",function(){
					navigator.notification.confirm(
						'您要取消註冊嗎 ?',
						function(btnIndex){
							if(btnIndex == 1){location.href="login.html";}
						},
						'就差一點點了',
						['是的','不']
					);
				},false);
			},false);
			$("#inputimg").hide();
		}
		
		function getimage()
		{
			document.addEventListener("deviceready",function(){SpinnerPlugin.activityStart("圖片載入中...");},false);
			$("#imglbl").css("display","none");
			var preview = document.getElementById("preview");
            var file    = document.querySelector('input[type=file]').files[0];
            var reader  = new FileReader();
			var image;

            reader.addEventListener("load", function(){
			  document.getElementById("preview").style.display = "block";
              preview.src = reader.result;
			  $("#preview").cropper({
				  aspectRatio: 1/1,
				  zoomable: false,
				  rotatable: false,
				  crop: function(){
					  document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
					  image = imagebase64 = "";
					  image = $("#preview").cropper("getCroppedCanvas");
					  imagebase64 = image.toDataURL('image/png');
				  }
			  })
            }, false);
			
            if (file) {
              reader.readAsDataURL(file);
            }
			
        }
		
		function register()
        {
			document.addEventListener("deviceready",function(){SpinnerPlugin.activityStart("載入中...");},false);
			var userData = {MODE: $("#MODE").val(),ID: $("#ID").val(),PWD: $("#PWD").val(),NAME: $("#NAME").val(),IMAGE: imagebase64};
			var data = JSON.stringify(userData);
			 
			$.ajax({
                url: "http://192.192.155.108/serv/ServicePool.asmx/Register",
                contentType: "application/json; charset=utf-8",
                dataType: "text",
				data: data,
                type: "POST",
                async: false,
                success: function(check){
					var message = (JSON.parse(check)).d;
					if(message == "ok"){
						window.localStorage["ID"] = $("#ID").val();
						window.localStorage["Mode"] = $("#MODE").val();
						window.localStorage["Name"] = $("#NAME").val();
						if(imagebase64 != ""){window.localStorage["Image"] = imagebase64;}
						if($("#MODE").val() == "諮商師")
						{
							document.addEventListener("deviceready",function(){
							    location.href="./consultant/main.html";
							    SpinnerPlugin.activityStop();
							    navigator.notification.alert(
                                    '註冊完成，歡迎使用 !',
                                    null,
                                    '與你相鬱好幸運',
                                    '確定'
                                );
			                },false);
						}else
						{
							location.href = "signUp2.html";
						    document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
						}
					}else if(message == "帳號已存在或者該ID已被使用。 \n已註冊者請直接登入。"){
						document.addEventListener("deviceready",function(){
							location.href="login.html";
							SpinnerPlugin.activityStop();
							navigator.notification.alert(
                                message,
                                null,
                                '我們見過面了',
                                '確定'
                            );
			            },false);
					}else if(message == "deleted"){
						document.addEventListener("deviceready",function(){
							SpinnerPlugin.activityStop();
							navigator.notification.confirm(
                                '發現已刪除之舊帳號，是否回復 ?',
                                function(btnIndex){
									if(btnIndex == 1){
										recovery();
									}else if(btnIndex == 2){
										location.href="signUp.html";
									}},
                                '隨時能回心轉意',
                                ['回復帳號','取消']
                            );
			            },false);
					}else if(message == "資料不完整，請檢查。"){
						document.addEventListener("deviceready",function(){
							SpinnerPlugin.activityStop();
							navigator.notification.alert(
                                message,
                                null,
                                '好像少了些什麼',
                                '好'
                            );
			            },false);
					}else{
						document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
						alert(message);
					}
				},
                error: function(xhr, ajaxOptions, thrownError) {
					document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
					alert(xhr.readyState + " " + ajaxOptions + " " + thrownError + "\\r" + xhr.responseText);
                }
            });
        }
		
		function recovery()
		{
			document.addEventListener("deviceready",function(){SpinnerPlugin.activityStart("正在重新啟用帳號...");},false);
			var userData = {ID: $("#ID").val()};
			var data = JSON.stringify(userData);
			 
			$.ajax({
                url: "http://192.192.155.108/serv/ServicePool.asmx/Recovery",
                contentType: "application/json; charset=utf-8",
                dataType: "text",
				data: data,
                type: "POST",
                async: false,
                success: function(check){
					var message = (JSON.parse(check)).d;
					if(message == "ok"){
						document.addEventListener("deviceready",function(){
							location.href="login.html";
							SpinnerPlugin.activityStop();
							navigator.notification.alert(
                                '已經為你重啟帳號，請再次登入。',
                                null,
                                '歡迎再次回來',
                                '太好了'
                            );
			            },false);
					}else{
						document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
						alert(message);
					}
				},
                error: function(xhr, ajaxOptions, thrownError) {
					document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
					alert(xhr.readyState + " " + ajaxOptions + " " + thrownError + "\\r" + xhr.responseText);
                }
            });
		}
    </script> 
</head>
<body onLoad="backbtn()">
    
    <div data-role="page">
        <div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="a">
           <div data-role="header" data-theme="a" font style="font-size: 22px">
             <h1><img style="padding-top: 4px" src="img/signuptitle.png" width="100%"></h1>
             <a id="btnprev" style="top:10px" data-role="button" ><img src="img/up.png" border="0"></a>
           </div>
        </div>

        <div align="center" data-role="content" >
           <div data-role="fieldcontain">
              <table align="center" width="90%" border="0">
               <tbody align="center" valign="middle" style="height: auto">
                 <tr>
                   <td width="20%" class="label">身分&nbsp;</td>
                   <td>
                      <select id="MODE">
                       <option value="1">一般使用者</option>
                       <option value="2">諮商師</option>
                      </select>
                   </td>
                 </tr>
                 <tr>
                   <td class="label">帳號&nbsp;<br>(英數)&nbsp;</td>
                   <td><input type="text" onkeyup="value=value.replace(/[\W]/g,'')" placeholder="註冊後無法更改" id="ID"/></td>
                 </tr>
                 <tr>
                   <td class="label">密碼&nbsp;</td>
                   <td><input type="password" id="PWD" /></td>
                 </tr>
                 <tr>
                   <td class="label">暱稱&nbsp;</td>
                   <td><input type="text" id="NAME"/></td>
                 </tr>
                 <tr>
                   <td class="label">照片&nbsp;<br>(選填)&nbsp;</td>
                   <td id="imglbl" width="80%"><input type="button" id="btnchoose" value="選擇照片"></td>
				   <td><img id="preview" src="" width="100%" alt="(圖片預覽)"></td>
                 </tr>
				 <tr>
        			<td colspan="2"><input type="file" id="inputimg" onchange="getimage()" accept="image/*"/></td>
        		 </tr>
                 <tr>
                   <td colspan="2"><button type="button" id="btnnext">下一步</button></td>
                 </tr>
               </tbody>
              </table>
		   </div>
           
        </div>
           
        </div>
</body>
</html>