<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" name="viewport" content="width=device-width; initial-scale=1; charset=utf-8">
    <title>諮商設定</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <link href="../css/two.css" rel="stylesheet" type="text/css">
    <link href="../css/all.css" rel="stylesheet" type="text/css">
    <script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="../cordova.js"></script>

    <style type="text/css">
	  #info{
		  background-color: aquamarine;
		  font-size: 15px;
	  }
	  table{padding-top: 0px;}
	  #prvlbl{visibility: hidden;}
	  #preview{display: none;}
    </style>
    
    <script type="text/javascript">
		$(document).ready(function(){$("#btnprev").click(function(){location.href="../D_member.html";})});
		$(document).ready(function(){$("#btnhome").click(function(){location.href="MAIN.html";})});
		$(document).ready(function(){$(".label").css({fontWeight:"bold"})});
		$(document).ready(function(){$("#btnchange").click(update)});
		$(document).ready(function(){
			if(window.localStorage["First"] == "true")
			{
				$("#info").css("display","none");
				document.querySelectorAll("div")[1].style.fontSize = "22px";
				document.querySelectorAll("img")[0].style.paddingTop = "4px";
				$("#btnchange").attr("value","送出").button("refresh");
			}
			getlocation();
		});

		function backbtn(){
			document.addEventListener("deviceready",function(){
				document.addEventListener("backbutton",function(){
					location.href="../D_member.html";
				},false);
			},false);
		}
		
		function getlocation(){
			$.ajax({
				url: "http://192.192.155.108/serv/ServicePool.asmx/GetLocation",
				dataType: "xml",
				type: "GET",
				async: false,
				success: function(check){
					var locations = check.firstChild.getElementsByTagName("ArrayOfString");
					for(i=0;i<locations.length;i++){
						$("<option/>",{
							"value": locations[i].getElementsByTagName("string")[0].innerHTML,
							"text": locations[i].getElementsByTagName("string")[1].innerHTML
						}).appendTo("#CCITY");
					}
				},
				error: function(){
					if(thrownError.toString().slice(0,12) == "NetworkError")
					{
						document.addEventListener("deviceready",function(){
							history.back();
			                navigator.notification.alert(
                                '伺服器連線失敗，請檢查網路。',
                                null,
                                '⚠️ 錯誤',
                                '確定'
                            );
			            },false);
					}else
					{
						alert("[Ready State] " + xhr.readyState + "\n[Ajax Options] " + ajaxOptions + "\n[Thrown Error]\n" + thrownError + "\n\n[Response Text] " + xhr.responseText);
					}
				}
			});
		}
		
		function update()
        {
			if(($("#CCITY").val() == "" || $("#CNAME").val() == "" || $("#CEXPERTISE").val() == "" || $("#CEXP").val() == "" || $("#CMESSAGE").val() == "") && window.localStorage["First"] == "true")
			{
				document.addEventListener("deviceready",function(){
			        navigator.notification.alert(
                        '部分的資料尚未填寫 !',
                        null,
                        '似乎少了些什麼',
                        '確定'
                    );
			    },false);
			}else
			{
				document.addEventListener("deviceready",function(){SpinnerPlugin.activityStart("儲存中...");},false);
			    var dt = {FIRST: window.localStorage["First"], ID: window.localStorage["ID"], LOCATION: $("#CCITY").val(), REALNAME: $("#CNAME").val(), EXPERTISE: $("#CEXPERTISE").val(), EXP: $("#CEXP").val(), MESSAGE: $("#CMESSAGE").val()};
				if($("#CCITY").val() == null){dt = {FIRST: window.localStorage["First"], ID: window.localStorage["ID"], LOCATION: "", REALNAME: $("#CNAME").val(), EXPERTISE: $("#CEXPERTISE").val(), EXP: $("#CEXP").val(), MESSAGE: $("#CMESSAGE").val()};}
			    var data = JSON.stringify(dt);
			     
			    $.ajax({
                    url: "http://192.192.155.108/serv/ServicePool.asmx/UpdateConsultant",
                    contentType: "application/json; charset=utf-8",
                    dataType: "text",
			    	data: data,
                    type: "POST",
                    async: false,
                    success: function(check){
			    		var cname = (JSON.parse(check)).d;
						var msg;
						if(cname == $("#CNAME").val())
						{
							msg = "相關資料已建立 !";
							window.localStorage["First"] = "";
						}else if(cname == "沒有資料需要更改。"){msg = cname;}
						else{msg = "已成功更改" + cname;}
						
			    		location.reload();
			    		document.addEventListener("deviceready",function(){
			    			SpinnerPlugin.activityStop();
			                navigator.notification.alert(
                                msg,
                                null,
                                '更改完成',
                                '確定'
                            );
			            },false);
			    	},
                    error: function(xhr, ajaxOptions, thrownError) {
			    		document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
			    		if(thrownError.toString().slice(0,12) == "NetworkError")
					    {
					    	document.addEventListener("deviceready",function(){
			                    navigator.notification.alert(
                                    '伺服器連線失敗，請檢查網路。',
                                    null,
                                    '⚠️ 錯誤',
                                    '確定'
                                );
			                },false);
					    }else
					    {
					    	alert("[Ready State] " + xhr.readyState + "\n[Ajax Options] " + ajaxOptions + "\n[Thrown Error]\n" + thrownError + "\n\n[Response Text] " + xhr.responseText);
					    }
                    }
                });
			}
        }
	</script>

</head>
<body onLoad="backbtn()">
    <div data-role="page" id="pageone">
        <div style="font-size:10px;text-align: center" data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="a">
            <h1><img style="padding-top: 12px" src="../img/consset.webp" width="100%"></h1>
			<a id="btnprev" style="top:12px" data-role="button" ><img src="../img/up.webp" border="0"></a>
            <a id="btnhome" style="top:10px" data-role="button" ><img src="../img/home.webp" border="0"></a>
			<span id="info">&nbsp;不需更改的項目請留白&nbsp;</span>
        </div>
        
        <div class="cot" align="center" data-role="content">
        <table width="90%" align="center" border="0">
        	<tbody align="center" valign="middle" style="height: auto">
				<tr id="petlbl">
                   <td class="label">居住地區&nbsp;</td>
				   <td colspan="2">
					   <select id="CCITY"/>
					       <option selected hidden disabled>請選擇地區</option>
			           </select>
			       </td>
                </tr>
        		<tr>
        			<td width="25%" class="label">真實姓名&nbsp;</td>
        			<td colspan="2"><input class="CNAME" type="text" id="CNAME"/></td>
        		</tr>
				<tr id="petlbl">
                   <td class="label">專長取向&nbsp;</td>
                   <td colspan="2"><input type="text" id="CEXPERTISE"/></td>
                </tr>
        		<tr>
                   <td class="label">相關經歷&nbsp;</td>
                   <td colspan="2"><textarea id="CEXP"></textarea></td>
                </tr>
				<tr>
                   <td class="label">個性小語&nbsp;</td>
                   <td colspan="2"><textarea id="CMESSAGE"></textarea></td>
                </tr>
        		<tr>
        			<td colspan="3"><input id="btnchange" type="button" value="更改" /></td>
        		</tr>
        	</tbody>
        </table>
		</div>
    </div>
</body>
</html>

