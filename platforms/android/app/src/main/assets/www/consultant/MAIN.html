<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" name="viewport" content="width=device-width, initial-scale=1; charset=utf-8">
    <title>首頁</title>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <link href="../css/two.css" rel="stylesheet" type="text/css">
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="../cordova.js"></script>
	
    <style>
		#btnmember{left: 7px; top: 8px; padding: 0;width: auto;height: 35px;padding-top: 5px;}
		#btnlogout{right: 10px; top: 10px;}
		#showname{vertical-align: super;}
		#pageone{position: fixed;}
		table{padding-top: 3%;}
		#lblspan{
		   font-size: 15px;
		   background-color:#C3E056;
	    }
		#notify{font-size: 15px;}
		#lock{
			font-size: 12px;
			font-weight: bold;
		}
	</style>

    <script>
		$(document).ready(function(){$("#btnlogout").click(logout)});
		$(document).ready(function(){$("#btnmember").click(function(){location.href="../D_member.html";})});
		$(document).ready(function(){$("#btnrecord").click(function(){location.href="F_RECORD.html";})});
		$(document).ready(loadinfo);
		
		var users;
		
		function backbtn(){
			document.addEventListener("deviceready",function(){
				document.addEventListener("backbutton",function(){
					navigator.notification.confirm(
						'你要退出程式嗎 ?',
						function(btnIndex){
							if(btnIndex == 1){navigator.app.exitApp();}
						},
						'下次見 ?',
						['是的','不']
					);
				},false);
			},false);
		}
		
		function loadinfo(){
			if(window.localStorage["First"] == "true")
			{
				document.addEventListener("deviceready",function(){
                     navigator.notification.alert(
                          '為了使您的諮商對象更了解您 \n請先填寫一些資料 !',
                          function(){location.href = "./D_PRIVACY.html";},
                          '歡迎使用，諮商師 !',
                          '確定'
                     );
			    },false);
			}
			
			if(window.localStorage["Name"] != null)
			{
				document.getElementById("showname").innerHTML = " " + window.localStorage["Name"];
				if(window.localStorage["Image"] != null){document.getElementById("userimage").src = window.localStorage["Image"];}
				getusers();
			}else
			{
				$("#btnlogout").hide();
				document.getElementById("showname").innerHTML = " (未登入)";
				$("#ALLUSERS").attr("disabled","disabled").selectmenu("refresh");
			}
			
			if(window.localStorage["cUserID"] != null)
			{
				//the last option is the default one which value is null -> length -1
				var count = 1;
				for(i=1;i<document.getElementById("ALLUSERS").length;i++)
				{
					if(document.getElementById("ALLUSERS").options[i].value == window.localStorage["cUserID"]) break;
					else{count++;}
				}
				if(count < document.getElementById("ALLUSERS").length)
				{
					$("#btnrecord").removeAttr("disabled").button("refresh");
				    $("#ALLUSERS").val(window.localStorage["cUserID"]).selectmenu("refresh");
				    document.getElementById("userimg").src = window.localStorage["cPicture"];
				    setuser(document.getElementById("ALLUSERS"));
				}else if(count == document.getElementById("ALLUSERS").length)
				{
					document.getElementById("lock").style.display = "none";
					document.addEventListener("online",function(){
					    document.addEventListener("deviceready",function(){
			                navigator.notification.alert(
                                '目前的諮商對象已更換諮商師。 \n請重新選擇。',
                                function(){
					    			localStorage.removeItem("cUserID");
					    			localStorage.removeItem("cUserName");
					    			localStorage.removeItem("cPicture");
					    			localStorage.removeItem("cPrivacy");
					    		},
                                '⚠️ 錯誤',
                                '確定'
                            );
			            },false);
					},false);
					document.addEventListener("offline",function(){
						localStorage.removeItem("cUserID");
					    localStorage.removeItem("cUserName");
					    localStorage.removeItem("cPicture");
					    localStorage.removeItem("cPrivacy");
					},false);
				}
			}else{document.getElementById("lock").style.display = "none";}
        }
		
		function getusers(){
			var userData = {ConsultantID: window.localStorage["ID"]};
			var data = JSON.stringify(userData);
			
			$.ajax({
				url: "http://192.192.155.108/serv/ServicePool.asmx/GetUsers",
				contentType: "application/json; charset=utf-8",
                dataType: "text",
				data: data,
                type: "POST",
                async: false,
                success: function(check){
					users = (JSON.parse(check)).d;
					for(i=0;i<users.length;i++)
					{
						$("<option/>",{
							"value": users[i][0],
							"text": users[i][1]
						}).appendTo("#ALLUSERS");
					}
				},
                error: function(xhr, ajaxOptions, thrownError) {
					if(thrownError.toString().slice(0,12) == "NetworkError")
					{
						document.addEventListener("deviceready",function(){
			                navigator.notification.alert(
                                '伺服器連線失敗，請檢查網路。',
                                null,
                                '⚠️ 錯誤',
                                '確定'
                            );
			            },false);
					}else
					{
						alert("[Ready State] " + xhr.readyState + "\n[Ajax Options] " + ajaxOptions + "\n[Thrown Error]\n" + thrownError + "\n\n[Response Text] " + xhr.responseText);
					}
                }
			});
		}
		
		function setuser(user){
			window.localStorage["cUserID"] = user.value;
			window.localStorage["cUserName"] = user.options[user.selectedIndex].text;
			window.localStorage["cPrivacy"] = users[user.selectedIndex-1][3];
			if(users[user.selectedIndex-1][2] != ""){window.localStorage["cPicture"] = users[user.selectedIndex-1][2];}
			else{window.localStorage["cPicture"] = "../img/member.webp";}
			document.getElementById("userimg").src = window.localStorage["cPicture"];
			$("#btnrecord").removeAttr("disabled").button("refresh");
			setprivacy();
		}
		
		function setprivacy(){
			if(window.localStorage["cPrivacy"] == "1111"){document.getElementById("lock").style.display = "none";}
			else{document.getElementById("lock").style.display = "block";}
			
			if(window.localStorage["cPrivacy"].charAt(0) == "1" || window.localStorage["cPrivacy"].charAt(1) == "1"){$("#btnC").removeAttr("disabled");}
			if(window.localStorage["cPrivacy"].charAt(2) == "1"){$("#btnB").removeAttr("disabled");}
			if(window.localStorage["cPrivacy"].charAt(3) == "1"){$("#btnE").removeAttr("disabled");}
			
			if(window.localStorage["cPrivacy"].charAt(0) == "0" || window.localStorage["cPrivacy"].charAt(1) == "0"){$("#btnC").attr("disabled","disabled");}
			if(window.localStorage["cPrivacy"].charAt(2) == "0"){$("#btnB").attr("disabled","disabled");}
			if(window.localStorage["cPrivacy"].charAt(3) == "0"){$("#btnE").attr("disabled","disabled");}
		}
		
		function logout(){
			document.addEventListener("deviceready",function(){SpinnerPlugin.activityStart("登出中...");},false);
			var userData = {ID: window.localStorage["ID"]};
			var data = JSON.stringify(userData);
			 
			$.ajax({
                url: "http://192.192.155.108/serv/ServicePool.asmx/Logout",
                contentType: "application/json; charset=utf-8",
                dataType: "text",
				data: data,
                type: "POST",
                async: false,
                success: function(check){
					var message = (JSON.parse(check)).d;
					if(message == "ok"){
						window.localStorage.clear();
			            document.addEventListener("deviceready",function(){
							location.href = "../main.html";
							SpinnerPlugin.activityStop();
                            navigator.notification.alert(
                                 '您已登出 !',
                                 null,
                                 '與你相鬱好幸運',
                                 '確定'
                            );
			            },false);
					}else{
						SpinnerPlugin.activityStop();
						alert(message);
					}
				},
                error: function(xhr, ajaxOptions, thrownError) {
					document.addEventListener("deviceready",function(){SpinnerPlugin.activityStop();},false);
					if(thrownError.toString().slice(0,12) == "NetworkError")
					{
						document.addEventListener("deviceready",function(){
			                navigator.notification.alert(
                                '伺服器連線失敗，請檢查網路。',
                                null,
                                '⚠️ 錯誤',
                                '確定'
                            );
			            },false);
					}else
					{
						alert("[Ready State] " + xhr.readyState + "\n[Ajax Options] " + ajaxOptions + "\n[Thrown Error]\n" + thrownError + "\n\n[Response Text] " + xhr.responseText);
					}
                }
            });
		}
		
		var id = 1;
        function next()
		{
	       id = (id + 1) % 6;
	       document.getElementById("image").src = "../img/" + id + ".webp";
        }
    </script>
</head>

<body onLoad="backbtn()">
    <div data-role="page" id="pageone">
         <div data-role="header" data-theme="a" data-position="fixed" data-tap-toggle="false" style=" font-size: 20px; width:100%; margin: auto; font-weight: bolder; text-align: center">
	        <h1><img style="padding-top: 2px" src="../img/title01.webp" width="100%"></h1>
            <a id="btnmember" data-role="button">&nbsp;<img width="31" id="userimage" src="../img/member.webp"><font id="showname"></font>&nbsp;</a>
            <a id="btnlogout" data-role="button">登出</a>
			<span id="notify">您有<span id="noticount"></span>則諮商訊息&nbsp;&nbsp;<a onClick="javascript: location.href =''">查看</a></span>
		 </div>

        <div data-role="content" >
		   <table align="center" width="90%">
			    <tr>
			    	<td style="padding-top: 5px" rowspan="2" width="35%"><img width="100%" id="userimg" src="../img/member.webp"></td>
			    	<td>
			    		<select data-mini="true" id="ALLUSERS" onChange="setuser(this)">
			    			<option selected hidden disabled>請選擇諮商對象</option>
			    		</select>
			    	</td>
			    </tr>
			    <tr>
					<td><span id="btnspan"><input data-mini="true" disabled id="btnrecord" type="button" value="訪談紀錄"></span></td>
			    </tr>
			   <tr><td colspan="2"><span id="lock">*該使用者已鎖定部分資料之瀏覽權限。</span></td></tr>
		   </table>
		   
           <table align="center" width="90%">
           	   <tr><td><button disabled id="btnC" onClick="javascript: location.href ='C_MEASUREMENT.html'"><img src="../img/hert.webp">檢測數據</button></td></tr>
           	   <tr><td><button disabled id="btnB" onClick="javascript: location.href = 'B_DIARY.html'"><img src="../img/diary.webp">&nbsp;&nbsp;&nbsp;&nbsp;日記查閱</button></td></tr>
           	   <tr><td><button disabled id="btnE" onClick="javascript: location.href = 'E_SLEEP.html'"><img src="../img/sleep.webp">&nbsp;睡眠紀錄</button></td></tr>
		   </table>
      </div>
	</div>
	</body>
</html>